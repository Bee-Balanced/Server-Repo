<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weekly Progress</title>
  <link rel="stylesheet" href="/styles/home.css">
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js"></script>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="home-container">

    <!-- Charts Section -->
    <div class="chart-feedback-container">
      <% const sections = ['overall', 'mental', 'physical']; %>
      <% sections.forEach(section => { %>
        <div class="chart-feedback-item">
          <div id="<%= section %>Chart" class="chart"></div>
          <div class="chart-button">
            <a 
              href="<%= section === 'overall' ? '/survey' : `/survey?section=${section}` %>" 
              class="btn">
              Take <%= section.charAt(0).toUpperCase() + section.slice(1) %> Survey
            </a>
          </div>
        </div>
      <% }); %>
    </div>

    <script src="/js/beeAnimation.js"></script>
    <script>
      function showAdvice(id, prefix) {
        document.querySelectorAll(`div[id^="${prefix}Advice"]`).forEach(el => el.style.display = 'none');
        if (id) document.getElementById(id).style.display = 'block';
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const charts = {
          overall: <%- JSON.stringify(overallData) %>,
          mental: <%- JSON.stringify(mentalData) %>,
          physical: <%- JSON.stringify(physicalData) %>
        };
        function drawChart(chartId, title, data) {
        const x = data.map(e => e.date);
        const y = data.map(e => e.avgScore);

        if (!x.length) {
          document.getElementById(chartId).innerHTML = 
          '<div style="display: flex; justify-content: center; align-items: center; height: 100%; background-color: #cae9f6; border-radius: 8px; border: 2px solid #ffd700; font-size: 24px; font-weight: bold; color: #ffd700; text-align: center; box-sizing: border-box;">No data for the past 2 weeks.</div>';
          return;
        }
        const lastX = x.at(-1);
        const lastY = y.at(-1);

        Plotly.newPlot(chartId, [{
          x,
          y,
          type: 'scatter',
          mode: 'lines+markers',
          marker: { color: '#FFFFFF' },
          line: { color: '#FFFFFF' }
        }], {
          title: title,
          titlefont: { color: '#FFD700' },
          xaxis: {
            title: "Date",
            type: 'category',
            tickfont: { color: '#37AE0F' },
            linecolor: '#37AE0F'
          },
          yaxis: {
            title: "Score",
            range: [0, 10],
            tickfont: { color: '#37AE0F' },
            linecolor: '#37AE0F'
          },
          plot_bgcolor: '#cae9f6',
          paper_bgcolor: '#cae9f6',
          images: [{
            source: "/images/bee.gif",
            x: lastX,
            y: lastY,
            xref: "x",
            yref: "y",
            sizex: 3,
            sizey: 3,
            xanchor: "center",
            yanchor: "middle",
            layer: "above"
          }]
        });
      }

        drawChart("overallChart", "Overall Health (Last 2 Weeks)", charts.overall);
        drawChart("mentalChart", "Mental Health (Last 2 Weeks)", charts.mental);
        drawChart("physicalChart", "Physical Health (Last 2 Weeks)", charts.physical);
      });
    </script>
  </div>
  <footer class="home-footer">
    <p>If you have any questions, please contact <strong>Davis Yi</strong> at 
      <a href="mailto:davisdaehanyi@gmail.com">davisdaehanyi@gmail.com</a>.
    </p>
  </footer>
</body>
</html>
